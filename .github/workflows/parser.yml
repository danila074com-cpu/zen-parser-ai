name: Zen Parser

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  parse-articles:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: ‚éî Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        echo "=== –û–ß–ò–°–¢–ö–ê –ö–≠–®–ê –ò –ü–ï–†–ï–£–°–¢–ê–ù–û–í–ö–ê ==="
        npm cache clean --force
        rm -rf node_modules
        rm -f package-lock.json
        echo "=== –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô ==="
        npm install
        echo "=== –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò ==="
        npm list --depth=0
        
    - name: üîç Debug - Check environment
      run: |
        echo "=== –ü–†–û–í–ï–†–ö–ê –°–†–ï–î–´ ==="
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: $(pwd)"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
        ls -la
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ parser.js:"
        ls -la parser.js
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ AI —Å–∫—Ä–∏–ø—Ç–∞:"
        ls -la scripts/process-with-ai.js || echo "AI —Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
    - name: üöÄ Run parser
      run: |
        echo "=== –ó–ê–ü–£–°–ö PARSER ==="
        node parser.js
        
    - name: ü§ñ AI –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç–µ–π
      run: |
        echo "=== –ó–ê–ü–£–°–ö AI –û–ë–†–ê–ë–û–¢–ö–ò ==="
        echo "ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å: GPT-3.5 Turbo"
        echo "üìù –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—å–∏ —á–µ—Ä–µ–∑ OpenAI..."
        node scripts/process-with-ai.js
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
    - name: üìÇ Check results
      run: |
        echo "=== –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ==="
        find . -name "*.xlsx" -o -name "*.csv" 2>/dev/null || echo "Excel —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        ls -la results/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ results –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        ls -la processed/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ processed –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        
        if [ -d "results/" ]; then
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ results:"
          ls -la results/
          find results/ -type f -name "*.xlsx"
        fi
        
        if [ -d "processed/" ]; then
          echo "ü§ñ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ processed:"
          ls -la processed/
          find processed/ -type f -name "*.xlsx"
        fi
        
    - name: üíæ Upload results
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: zen-articles
        path: |
          results/
          processed/
        retention-days: 30
        
    - name: üìä Display success
      if: success()
      run: |
        echo "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "ü§ñ AI –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!"
        echo "üìÅ –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö:"
        echo "   - results/ - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏"
        echo "   - processed/ - —É–Ω–∏–∫–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ AI —Å—Ç–∞—Ç—å–∏"
        echo "‚è∞ –í—Ä–µ–º—è: $(date)"
        
    - name: üêõ Display failure info
      if: failure()
      run: |
        echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
        echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
        echo "‚è∞ –í—Ä–µ–º—è: $(date)"